{% extends "base.html" %}

{% block title %}Explore Map - Geo Web{% endblock %}

{% block content %}
<div class="map-hero">
  <h1>Interactive Geospatial Explorer</h1>
  <p>Visualize burned areas and environmental factors across Australia</p>
</div>

<div class="map-container">
  <div id="map"></div>

  <div class="layer-control">
    <h3>Map Layers</h3>
    <div class="layer-option">
      <input type="checkbox" id="burned-area-toggle" checked>
      <label for="burned-area-toggle">Burned Area (2019-2020)</label>
    </div>
    <div class="layer-option">
      <input type="checkbox" id="temp-toggle">
      <label for="temp-toggle">Land Surface Temperature (2019)</label>
    </div>
    <div class="layer-option">
      <input type="checkbox" id="ndvi-toggle">
      <label for="ndvi-toggle">NDVI</label>
    </div>
    <div class="layer-option">
      <input type="checkbox" id="satellite-toggle" checked>
      <label for="satellite-toggle">Google Satellite</label>
    </div>
  </div>
</div>

<div class="map-legend">
  <h4>Legend</h4>
  <div class="legend-item burned-area-legend">
    <div class="legend-color"></div>
    <span>Burned Areas</span>
  </div>
  <div class="legend-item temp-legend">
    <div class="legend-color"></div>
    <span>Temperature (Â°C)</span>
  </div>
  <div class="legend-item ndvi-legend">
    <div class="legend-color"></div>
    <span>Vegetation Index</span>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<script>
// Define the CRS for Australia
const crs = L.CRS.EPSG3857; // Standard Web Mercator used by Google Maps

// Initialize the map with proper CRS
const map = L.map('map', {
  crs: crs
}).setView([-25.2744, 133.7751], 5);

// Add Google Satellite layer
const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  subdomains: ['mt0','mt1','mt2','mt3'],
  attribution: 'Google Satellite'
}).addTo(map);

// Define the exact bounds of your image overlays in [SW, NE] format
const australiaBounds = L.latLngBounds(
  L.latLng(-44, 112), // Southwest corner
  L.latLng(-10, 154)  // Northeast corner
);

// Layer groups
const burnedAreaLayer = L.layerGroup();
const tempLayer = L.layerGroup();
const ndviLayer = L.layerGroup();

// Add image overlays with proper bounds and CRS
const burnedAreaOverlay = L.imageOverlay(
  '{{ url_for("static", filename="burned_area_aus_2021_3.png") }}',
  australiaBounds,
  { opacity: 0.7 }
).addTo(burnedAreaLayer);

const tempOverlay = L.imageOverlay(
  '{{ url_for("static", filename="ForestLossAus_3.png") }}',
  australiaBounds,
  { opacity: 0.7 }
).addTo(tempLayer);

const ndviOverlay = L.imageOverlay(
  '{{ url_for("static", filename="ndvi_1.png") }}',
  australiaBounds,
  { opacity: 0.7 }
).addTo(ndviLayer);

// Fit map to Australia bounds initially
map.fitBounds(australiaBounds);

// Layer control logic
document.getElementById('burned-area-toggle').addEventListener('change', function(e) {
  if (e.target.checked) burnedAreaLayer.addTo(map);
  else map.removeLayer(burnedAreaLayer);
});

document.getElementById('temp-toggle').addEventListener('change', function(e) {
  if (e.target.checked) tempLayer.addTo(map);
  else map.removeLayer(tempLayer);
});

document.getElementById('ndvi-toggle').addEventListener('change', function(e) {
  if (e.target.checked) ndviLayer.addTo(map);
  else map.removeLayer(ndviLayer);
});

document.getElementById('satellite-toggle').addEventListener('change', function(e) {
  if (e.target.checked) satellite.addTo(map);
  else map.removeLayer(satellite);
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Explore Map - Geo Web{% endblock %}

{% block content %}
<div class="map-hero">
  <h1>Interactive Geospatial Explorer</h1>
  <p>Visualize burned areas and environmental factors across Australia</p>
</div>

<div class="map-container">
  <div id="map"></div>

  <div class="layer-control">
    <h3>Map Layers</h3>
    <div class="layer-option">
      <input type="checkbox" id="burned-area-toggle" checked>
      <label for="burned-area-toggle">Burned Area (2019-2020)</label>
    </div>
    <div class="layer-option">
      <input type="checkbox" id="temp-toggle">
      <label for="temp-toggle">Land Surface Temperature (2019)</label>
    </div>
    <div class="layer-option">
      <input type="checkbox" id="ndvi-toggle">
      <label for="ndvi-toggle">NDVI</label>
    </div>
    <div class="layer-option">
      <input type="checkbox" id="satellite-toggle" checked>
      <label for="satellite-toggle">Google Satellite</label>
    </div>

    <!-- Add transparency controls -->
    <div class="layer-opacity">
      <label for="opacity-slider">Layer Opacity:</label>
      <input type="range" id="opacity-slider" min="0" max="1" step="0.1" value="0.7">
    </div>
  </div>
</div>

<!-- Legend remains the same -->

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Initialize the map with proper CRS
const map = L.map('map').setView([-25.2744, 133.7751], 5);

// Add Google Satellite layer
const satellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  maxZoom: 20,
  subdomains: ['mt0','mt1','mt2','mt3'],
  attribution: 'Google Satellite'
}).addTo(map);

// PRECISE BOUNDS FOR YOUR IMAGES - ADJUST THESE VALUES
// Format: [ [southwest_lat, southwest_lng], [northeast_lat, northeast_lng] ]
const imageBounds = L.latLngBounds(
  L.latLng(-43.7, 112.9),  // SW corner (adjust these values)
  L.latLng(-10.1, 153.6)   // NE corner (adjust these values)
);

// Layer groups
const burnedAreaLayer = L.layerGroup();
const tempLayer = L.layerGroup();
const ndviLayer = L.layerGroup();

// Create image overlays with the same bounds
function createOverlay(url, layer) {
  return L.imageOverlay(url, imageBounds, {
    opacity: 0.7,
    interactive: true,
    errorOverlayUrl: '/static/error_overlay.png',
    zIndex: 650
  }).addTo(layer);
}

// Add your overlays
const burnedAreaOverlay = createOverlay(
  '{{ url_for("static", filename="burned_area_aus_2021_3.png") }}',
  burnedAreaLayer
);

const tempOverlay = createOverlay(
  '{{ url_for("static", filename="ForestLossAus_3.png") }}',
  tempLayer
);

const ndviOverlay = createOverlay(
  '{{ url_for("static", filename="ndvi_1.png") }}',
  ndviLayer
);

// Add initial layers
burnedAreaLayer.addTo(map);

// Fit bounds to your image
map.fitBounds(imageBounds);

// Layer control logic
document.getElementById('burned-area-toggle').addEventListener('change', function(e) {
  e.target.checked ? burnedAreaLayer.addTo(map) : map.removeLayer(burnedAreaLayer);
});

document.getElementById('temp-toggle').addEventListener('change', function(e) {
  e.target.checked ? tempLayer.addTo(map) : map.removeLayer(tempLayer);
});

document.getElementById('ndvi-toggle').addEventListener('change', function(e) {
  e.target.checked ? ndviLayer.addTo(map) : map.removeLayer(ndviLayer);
});

document.getElementById('satellite-toggle').addEventListener('change', function(e) {
  e.target.checked ? satellite.addTo(map) : map.removeLayer(satellite);
});

// Opacity control
document.getElementById('opacity-slider').addEventListener('input', function(e) {
  const opacity = parseFloat(e.target.value);
  burnedAreaOverlay.setOpacity(opacity);
  tempOverlay.setOpacity(opacity);
  ndviOverlay.setOpacity(opacity);
});

// Debugging tool - uncomment to help find correct coordinates
/*
map.on('click', function(e) {
  console.log('Clicked at:', e.latlng.lat, e.latlng.lng);
});
*/
</script>
{% endblock %}